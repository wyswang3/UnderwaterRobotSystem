

---

# 项目代码质量评估报告（中文说明版）

> 本文档用于**帮助新成员快速理解当前项目代码规模、结构现状与主要风险点**。
> 评估结果不代表“代码写得不好”，而是用于**指导后续开发、重构与功能扩展的优先级**。

---

## 一、项目整体概况（先看这个）

* **项目根目录**：`UnderwaterRobotSystem`
* **扫描源文件数**：184 个
* **有效代码行数（LOC）**：18490 行

  * 注释行：5691 行
  * 空行：4790 行
* **项目规模判断**：
  👉 **中等规模工程项目**（不是 demo，也不是一次性脚本）

> 说明：
>
> * 这个体量已经明显超过“一个人随便改改就行”的阶段
> * 后续需要**模块化、流程化、规范化协作**

---

## 二、语言构成说明（项目是干什么的）

| 语言      | 文件数 | 代码行数  | 说明            |
| ------- | --- | ----- | ------------- |
| C / C++ | 114 | 12372 | 核心控制、通信、硬件接口  |
| Python  | 61  | 5538  | 导航、数据采集、工具、脚本 |
| CMake   | 9   | 580   | 构建系统          |

**解读给新人：**

* 👉 **这是一个以 C++ 为核心的工程级系统**
* Python 主要用于：

  * 导航算法
  * 传感器数据采集
  * 上位机 / 工具脚本
* CMake 只是构建工具，不是业务逻辑

---

## 三、代码主要集中在哪些子系统（非常重要）

| 一级目录                          | 代码行数  | 含义                  |
| ----------------------------- | ----- | ------------------- |
| `OrangePi_STM32_for_ROV`      | 10109 | 香橙派 + STM32 控制与通信   |
| `Underwater-robot-navigation` | 7340  | 水下导航、IMU / DVL / 滤波 |
| `tools`                       | 886   | 工具脚本、评估工具           |
| `shared`                      | 75    | 少量共享数据结构            |

**解读给新人：**

* 项目**不是一个单体程序**
* 主要由两大块组成：

  1. **控制系统（香橙派侧）**
  2. **导航系统（传感器 + 算法）**
* 后续做上位机、实验、重构，基本都会围绕这两块展开

---

## 四、什么是「高风险文件」？为什么要关心它？

> 评估工具给每个源文件计算了一个**综合风险分数（Risk Score）**，综合考虑：
>
> * 文件行数
> * 超长函数
> * 逻辑嵌套深度
> * 分支数量（if / while / switch 等）
> * 注释比例

### Top 风险文件（节选）

| 文件                  | 风险说明                        |
| ------------------- | --------------------------- |
| `nav_daemon.cpp`    | 导航系统入口，**单个 main 函数 324 行** |
| `control_loop.cpp`  | 控制主循环，**核心控制逻辑高度集中**        |
| `config_loader.cpp` | 配置解析复杂，规则多、分支多              |
| `gcs_session.cpp`   | 上位机通信状态机，逻辑集中               |
| `dvl_driver.cpp`    | DVL 协议解析，嵌套最深               |

**给新人的直白解释：**

* 这些文件 **“不是不能跑，而是太重要、太复杂”**
* 一旦改错，可能：

  * 电机失控
  * 通信中断
  * 数据异常
* 所以后续重构、测试、评审都会优先从这里开始

---

## 五、超长函数统计（为什么我们不急着重构）

下面这些函数**已经明显超过“人脑一次能完全理解的范围”**：

| 文件                      | 函数                          | 长度    |
| ----------------------- | --------------------------- | ----- |
| `nav_daemon.cpp`        | `main`                      | 324 行 |
| `control_loop.cpp`      | `ControlLoop::run`          | 250 行 |
| `app_main.cpp`          | `app_main`                  | 192 行 |
| `manual_controller.cpp` | `ManualController::compute` | 189 行 |

**重要说明给新人：**

* 这些函数**不是现在就要你去改**
* 它们目前能稳定运行，是“系统能跑起来”的关键
* 后续会在：

  * 功能稳定
  * 上位机可用
  * 实验流程明确
    之后，再逐步拆分

---

## 六、模块依赖关系情况（好消息）

* **检测到模块数**：17 个
* **循环依赖数**：0

👉 **这是一个非常好的结果**

**说明：**

* 虽然代码复杂，但模块间没有“互相 include 乱成一团”
* 这意味着：

  * 未来重构是可控的
  * 不需要推倒重来

---

## 七、风险扫描结果说明（不是在骂人）

### 扫描内容包括：

* TODO / FIXME / HACK
* C 中危险函数（`memcpy`, `strcpy` 等）
* C++ 高风险语法
* Python 中宽泛异常捕获
* 控制系统关键字（estop / ttl / pwm 等）

### 扫描结果总结：

* TODO / FIXME：32 处
* C 风险函数：53 次
* C++ 高风险语法：61 次
* Python 风险用法：54 次

**重要解释：**

* 这不是“写得差”
* 而是**典型工程系统的真实状态**
* 后续会：

  * 逐步审计
  * 对关键路径加强测试
  * 非关键路径暂缓处理

---

## 八、为什么现在不立刻大规模重构？

这是一个**战略选择**，请新人务必理解：

> **当前阶段目标不是“代码优雅”，而是：**
>
> * 能稳定控制机器人
> * 能通过上位机远程操作
> * 能安全下水实验
> * 能积累真实数据

所以当前优先级是：

1. ✅ **上位机（GCS）可用**
2. ✅ **香橙派程序开机自启动**
3. ✅ **通信断链 / 超时 / 急停安全可靠**
4. ⏸️ **结构性重构（稍后进行）**

---

## 九、给新成员的工作建议

### 如果你是新加入的同学：

* **不要一上来就改 Top Risk 文件**
* 建议从以下方向入手：

  * 上位机工具
  * 数据可视化
  * 日志分析脚本
  * 测试用例补充
  * 文档与流程说明

### 如果你不确定改哪里：

👉 **先问，不要硬改控制主干**

---

## 十、总结一句话

> **这是一个“已经能跑、但需要工程化提升”的真实水下机器人系统。**
> 我们当前的目标是：
> **先把系统跑稳、跑通、跑安全，再逐步变得优雅。**

---
